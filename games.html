<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Gatot Kaca Adventure — Full</title>
<style>
  :root{
    --bg1:#0b1b3a; --bg2:#20103f; --panel: rgba(6,15,26,0.6);
    --accent:#ffd54a; --muted:#9aa6b2; --glass: rgba(255,255,255,0.03);
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;background:linear-gradient(180deg,var(--bg1),var(--bg2)); color:#eaf2ff; -webkit-font-smoothing:antialiased}
  #wrap{max-width:1100px;margin:24px auto;padding:16px}
  .card{
    background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    border-radius:14px; padding:12px; box-shadow: 0 14px 40px rgba(2,6,20,0.6); border:1px solid rgba(255,255,255,0.03);
  }

  /* Game container */
  #gameFrame{position:relative;height:640px;border-radius:12px;overflow:hidden;background:linear-gradient(180deg,#3b5fa8 0%, #553d9a 100%);box-shadow: inset 0 -60px 120px rgba(0,0,0,0.25), 0 10px 30px rgba(0,0,0,0.5);}
  canvas{display:block;width:100%;height:100%;}
  /* hud */
  .hud{position:absolute;left:18px;top:18px;z-index:50;display:flex;gap:10px;align-items:center}
  .scoreBox{background:var(--panel);padding:10px 14px;border-radius:10px;font-weight:700;color:#fff;backdrop-filter: blur(6px);border:1px solid rgba(255,255,255,0.02)}
  .topRight{position:absolute;right:18px;top:18px;z-index:60;display:flex;gap:8px}
  .smallBtn{background:var(--panel);border:1px solid rgba(255,255,255,0.03);padding:8px 12px;border-radius:8px;color:#eaf2ff;cursor:pointer}
  .smallBtn:hover{transform:translateY(-1px)}
  /* controls */
  .controls-left, .controls-right{position:absolute;bottom:22px;z-index:70;display:flex;flex-direction:column;gap:12px}
  .controls-left{left:18px}
  .controls-right{right:18px}
  .ctl{width:64px;height:64px;border-radius:12px;background:linear-gradient(180deg, rgba(255,255,255,0.03), rgba(0,0,0,0.12));display:flex;align-items:center;justify-content:center;font-size:22px;color:var(--accent);box-shadow:0 8px 18px rgba(2,6,20,0.45);user-select:none;touch-action:manipulation}
  /* center overlay (menu/game over) */
  .overlay{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;z-index:80;pointer-events:none}
  .panel{pointer-events:auto;background: linear-gradient(180deg, rgba(8,12,22,0.96), rgba(8,12,22,0.9));padding:22px;border-radius:14px;border:1px solid rgba(255,255,255,0.03);width:420px;text-align:center;box-shadow: 0 14px 40px rgba(2,6,20,0.6)}
  .panel h1{margin:0 0 6px;font-size:22px}
  .panel p{margin:0 0 14px;color:var(--muted)}
  .btnPrimary{background:linear-gradient(180deg,var(--accent),#e0b83d);border:none;padding:10px 18px;border-radius:10px;font-weight:800;cursor:pointer}
  .btnGhost{background:transparent;border:1px solid rgba(255,255,255,0.04);padding:8px 12px;border-radius:8px;color:var(--muted);cursor:pointer;margin-left:8px}
  /* level list */
  .levels{display:flex;gap:10px;flex-wrap:wrap;justify-content:center}
  .levelCard{min-width:120px;padding:10px;border-radius:8px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.02);cursor:pointer}
  .levelCard.active{outline:3px solid rgba(255,213,74,0.12)}
  /* mobile adjustments */
  @media (max-width:700px){
    #wrap{padding:8px}
    .panel{width:92%}
    .ctl{width:54px;height:54px}
  }
</style>
</head>
<body>
<div id="wrap" class="card">
  <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px">
    <div style="display:flex;gap:12px;align-items:center">
      <div style="font-weight:800;font-size:20px;">Gatot Kaca Adventure</div>
      <div style="color:var(--muted);font-size:13px">Hindari rintangan & kumpulkan skor</div>
    </div>
    <div style="display:flex;gap:8px;align-items:center">
      <button id="homePlay" class="smallBtn">Home</button>
      <button id="resetAll" class="smallBtn">Reset</button>
      <button id="musicToggle" class="smallBtn">Music: ON</button>
    </div>
  </div>

  <div id="gameFrame">
    <canvas id="gameCanvas" width="1000" height="600"></canvas>

    <div class="hud">
      <div class="scoreBox">Score: <span id="score">0</span></div>
      <div class="scoreBox" id="levelBox" style="background:transparent;border:1px solid rgba(255,255,255,0.03);font-weight:600">Level: <span id="levelLabel">1</span></div>
    </div>

    <div class="topRight">
      <button class="smallBtn" id="pauseBtn">Pause ⏸</button>
      <button class="smallBtn" id="toHomeBtn">Home ⤺</button>
    </div>

    <div class="controls-left">
      <div id="leftBtn" class="ctl">◀</div>
      <div id="rightBtn" class="ctl">▶</div>
    </div>
    <div class="controls-right">
      <div id="upBtn" class="ctl">▲</div>
      <div id="downBtn" class="ctl">▼</div>
    </div>

    <!-- overlay modal area -->
    <div id="menuOverlay" class="overlay">
      <div class="panel" id="menuPanel">
        <h1>Menu</h1>
        <p>Pilih level, atur musik, lalu tekan Play</p>
        <div class="levels" id="levelsList"></div>
        <div style="margin-top:14px">
          <button class="btnPrimary" id="playBtn">Play Game ▶</button>
          <button class="btnGhost" id="instructionsBtn">Instruksi</button>
        </div>
      </div>
    </div>

    <div id="gameOverOverlay" class="overlay" style="display:none">
      <div class="panel">
        <h1 id="goTitle">Game Over</h1>
        <p id="goText">Skor akhir: 0</p>
        <div>
          <button class="btnPrimary" id="retryBtn">Retry</button>
          <button class="btnGhost" id="backBtn">Kembali ke Home</button>
        </div>
      </div>
    </div>

    <div id="instrOverlay" class="overlay" style="display:none">
      <div class="panel">
        <h1>Instruksi</h1>
        <p>Gunakan tombol layar atau keyboard (← → ↑ ↓) untuk bergerak. Tekan Spasi atau ketuk layar untuk lompatan (flap). Hindari rintangan — melewati rintangan menambah skor.</p>
        <button class="btnPrimary" id="closeInstr">Tutup</button>
      </div>
    </div>
  </div>
</div>

<script>
/* ---------------------------
   Game logic + UI wiring
   - Hybrid control (flap + free movement)
   - 5 levels with distinct obstacle shapes
   - Audio generated with WebAudio (music + SFX)
   - Responsive canvas drawing
   --------------------------- */

const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
let W = canvas.width, H = canvas.height;
function fitCanvas(){ const rect = canvas.getBoundingClientRect(); W = canvas.width = rect.width; H = canvas.height = rect.height; }
window.addEventListener('resize', ()=>{ fitCanvas(); drawStaticBG(); });

fitCanvas();

/* ---------- Game State ---------- */
let running = false, paused = false;
let score = 0, hiScore = 0;
let currentLevel = 1, maxLevel = 5;
let tick = 0, obstacles = [], baseSpeed = 3.0, spawnTimer = 0;
const levelInfo = {
  1:{name:'Kotak Lebar', gap:180, shape:'rect'},
  2:{name:'Kotak Pendek', gap:150, shape:'rectShort'},
  3:{name:'Miring', gap:150, shape:'slanted'},
  4:{name:'Bulat', gap:130, shape:'circle'},
  5:{name:'Segitiga', gap:110, shape:'triangle'}
};

/* ---------- Player ---------- */
const player = {
  x: 160, y: H/2, w:54, h:66,
  vy:0, vx:0,
  gravity:0.28, lift:-6.6, speed:3.6, maxVy:9,
  color:'#ffd54a'
};

/* ---------- UI Elements ---------- */
const menuOverlay = document.getElementById('menuOverlay');
const gameOverOverlay = document.getElementById('gameOverOverlay');
const instrOverlay = document.getElementById('instrOverlay');
const playBtn = document.getElementById('playBtn');
const pauseBtn = document.getElementById('pauseBtn');
const toHomeBtn = document.getElementById('toHomeBtn');
const retryBtn = document.getElementById('retryBtn');
const backBtn = document.getElementById('backBtn');
const scoreEl = document.getElementById('score');
const levelLabel = document.getElementById('levelLabel');
const musicToggle = document.getElementById('musicToggle');
const resetAll = document.getElementById('resetAll');
const homePlay = document.getElementById('homePlay');
const levelsList = document.getElementById('levelsList');
const instructionsBtn = document.getElementById('instructionsBtn');
const closeInstr = document.getElementById('closeInstr');

const leftBtn = document.getElementById('leftBtn');
const rightBtn = document.getElementById('rightBtn');
const upBtn = document.getElementById('upBtn');
const downBtn = document.getElementById('downBtn');

/* ---------- Populate levels UI ---------- */
function populateLevels(){
  levelsList.innerHTML='';
  for(let i=1;i<=maxLevel;i++){
    const el = document.createElement('div');
    el.className = 'levelCard' + (i===currentLevel?' active':'');
    el.innerHTML = `<div style="font-weight:700">Level ${i}</div><div style="font-size:12px;color:var(--muted)">${levelInfo[i].name}</div>`;
    el.onclick = ()=>{ currentLevel = i; document.querySelectorAll('.levelCard').forEach(c=>c.classList.remove('active')); el.classList.add('active'); levelLabel.textContent = currentLevel; };
    levelsList.appendChild(el);
  }
}
populateLevels();

/* ---------- Audio: WebAudio synth ---------- */
const AudioCtx = window.AudioContext || window.webkitAudioContext;
let audioCtx = null;
let musicOn = true;
let musicNode = null;

function initAudio(){
  if(audioCtx) return;
  audioCtx = new AudioCtx();
  // create background ambient using oscillator + filter + gain
  const o1 = audioCtx.createOscillator();
  o1.type = 'sine'; o1.frequency.value = 120;
  const o2 = audioCtx.createOscillator();
  o2.type = 'triangle'; o2.frequency.value = 220;
  const gain = audioCtx.createGain(); gain.gain.value = 0.03;
  const filter = audioCtx.createBiquadFilter(); filter.type='lowpass'; filter.frequency.value=800;
  o1.connect(filter); o2.connect(filter); filter.connect(gain); gain.connect(audioCtx.destination);
  o1.start(); o2.start();
  musicNode = {o1,o2,gain,filter};
}
function setMusic(on){
  musicOn = on;
  if(!audioCtx && on) initAudio();
  if(musicNode){
    musicNode.gain.gain.value = on ? 0.03 : 0;
  }
  musicToggle.textContent = `Music: ${on?'ON':'OFF'}`;
}
setMusic(true);

/* sound effects using WebAudio simple synth */
function playSFX(type='blip'){
  if(!audioCtx) initAudio();
  const now = audioCtx.currentTime;
  const g = audioCtx.createGain(); g.gain.value = 0.0001;
  g.connect(audioCtx.destination);
  if(type==='blip'){
    const o = audioCtx.createOscillator(); o.type='square'; o.frequency.setValueAtTime(800,now);
    o.connect(g); o.start(now); o.stop(now+0.08);
    g.gain.exponentialRampToValueAtTime(0.07, now+0.005);
    g.gain.exponentialRampToValueAtTime(0.0001, now+0.09);
  } else if(type==='pop'){
    const b = audioCtx.createBufferSource();
    // use short noise
    const buffer = audioCtx.createBuffer(1, audioCtx.sampleRate*0.06, audioCtx.sampleRate);
    const data = buffer.getChannelData(0);
    for(let i=0;i<data.length;i++) data[i] = (Math.random()*2-1)*Math.exp(-i/data.length*6);
    b.buffer = buffer; b.connect(g); b.start(now); b.stop(now+0.06);
    g.gain.exponentialRampToValueAtTime(0.05, now+0.01);
    g.gain.exponentialRampToValueAtTime(0.0001, now+0.06);
  } else if(type==='boom'){
    const o = audioCtx.createOscillator();
    o.type='sawtooth'; o.frequency.setValueAtTime(200, now);
    o.connect(g); o.start(now); o.stop(now+0.28);
    g.gain.exponentialRampToValueAtTime(0.12, now+0.01);
    g.gain.exponentialRampToValueAtTime(0.0001, now+0.28);
  }
}

/* ---------- Drawing helpers ---------- */
function roundRect(ctx,x,y,w,h,r){
  ctx.beginPath();
  ctx.moveTo(x+r,y);
  ctx.lineTo(x+w-r,y);
  ctx.quadraticCurveTo(x+w,y,x+w,y+r);
  ctx.lineTo(x+w,y+h-r);
  ctx.quadraticCurveTo(x+w,y+h,x+w-r,y+h);
  ctx.lineTo(x+r,y+h);
  ctx.quadraticCurveTo(x,y+h,x,y+h-r);
  ctx.lineTo(x,y+r);
  ctx.quadraticCurveTo(x,y,x+r,y);
  ctx.closePath();
}

/* ---------- Background drawing (parallax mountains) ---------- */
function drawStaticBG(){
  // gradient sky
  const g = ctx.createLinearGradient(0,0,0,H);
  g.addColorStop(0,'#3b6fbf');
  g.addColorStop(0.6,'#5b3d9f');
  g.addColorStop(1,'#2b2940');
  ctx.fillStyle = g;
  ctx.fillRect(0,0,W,H);

  // parallax mountains layers
  drawMountains(0.12, H*0.55, '#083455', 0.7);
  drawMountains(0.45, H*0.66, '#1a2a4a', 0.9);
  drawMountains(0.78, H*0.78, '#20223a', 1.0);

  // soft vignette
  const vg = ctx.createRadialGradient(W/2,H/2,Math.max(W,H)/4, W/2,H/2, Math.max(W,H)/1.1);
  vg.addColorStop(0,'rgba(0,0,0,0)');
  vg.addColorStop(1,'rgba(0,0,0,0.35)');
  ctx.fillStyle = vg;
  ctx.fillRect(0,0,W,H);
}

function drawMountains(offset, baseY, color, scale){
  ctx.save();
  ctx.fillStyle = color;
  ctx.beginPath();
  ctx.moveTo(0,H);
  const step = Math.max(120, W/12);
  for(let x=0;x<=W+step;x+=step){
    const y = baseY - Math.sin((x*0.014)+(tick*0.004*offset))*40*scale - Math.cos((x*0.008)-(tick*0.002))*18;
    ctx.lineTo(x,y);
  }
  ctx.lineTo(W,H);
  ctx.closePath();
  ctx.fill();
  ctx.restore();
}

/* ---------- Player draw (Gatot Kaca simple cartoon) ---------- */
function drawPlayer(){
  ctx.save();
  ctx.translate(player.x, player.y);
  // shadow
  ctx.fillStyle='rgba(0,0,0,0.18)';
  ctx.beginPath(); ctx.ellipse(6, player.h/2 + 12, player.w*0.8, 12, 0, 0, Math.PI*2); ctx.fill();
  // body
  ctx.fillStyle = player.color;
  roundRect(ctx, -player.w/2, -player.h/2, player.w, player.h, 10); ctx.fill();
  // chest emblem
  ctx.fillStyle='#16222f'; ctx.beginPath(); ctx.arc(8, -4, 12, 0, Math.PI*2); ctx.fill();
  // eyes
  ctx.fillStyle='#081220'; ctx.fillRect(-12, -18, 8, 8); ctx.fillRect(6, -18, 8, 8);
  // cape (simple)
  ctx.fillStyle='rgba(255,170,60,0.07)';
  ctx.beginPath(); ctx.moveTo(-player.w/2+4, player.h/8); ctx.quadraticCurveTo(-player.w, player.h/2, -player.w/2+4, player.h/1.1); ctx.fill();
  ctx.restore();
}

/* ---------- Obstacles ---------- */
function spawnObstacle(){
  const lvl = levelInfo[currentLevel];
  const gap = Math.max(90, lvl.gap - Math.floor(tick/800));
  const mid = Math.random()*(H*0.55-120) + 80;
  const topH = Math.max(40, mid - gap/2);
  const bottomH = Math.max(40, H - (mid + gap/2));
  const x = W + 120;
  const base = {x, passed:false, speed: baseSpeed + Math.min(4, Math.floor(tick/1200))};
  if(lvl.shape==='rect') obstacles.push({...base, type:'rect', topH, bottomH, gap});
  else if(lvl.shape==='rectShort') obstacles.push({...base, type:'rectShort', topH:topH*0.6, bottomH:bottomH*0.6, gap:Math.max(100,gap-20)});
  else if(lvl.shape==='slanted') obstacles.push({...base, type:'slanted', topY:Math.max(30,mid - gap*0.6), tilt:(Math.random()*0.6-0.3), gap});
  else if(lvl.shape==='circle') obstacles.push({...base, type:'circle', centerY:mid, r: Math.max(28, gap/2)});
  else if(lvl.shape==='triangle') obstacles.push({...base, type:'triangle', mid, gap});
  // sometimes add moving enemy
  if(Math.random()<0.18 + currentLevel*0.03){
    obstacles.push({...base, type:'enemy', y: Math.random()*(H-120)+60, w:36, h:36, vx: - (base.speed+1.2) - Math.random()*1.2});
  }
}

function drawObstacles(){
  for(const o of obstacles){
    if(o.type==='rect' || o.type==='rectShort'){
      ctx.fillStyle='rgba(18,30,42,0.95)';
      roundRect(ctx, o.x-48, 0, 96, o.topH, 8); ctx.fill();
      roundRect(ctx, o.x-48, H-o.bottomH, 96, o.bottomH, 8); ctx.fill();
      ctx.fillStyle='rgba(255,255,255,0.02)'; ctx.fillRect(o.x-44, o.topH, 88, (H - o.topH - o.bottomH));
    } else if(o.type==='slanted'){
      ctx.fillStyle='rgba(26,44,62,0.98)';
      const w=120;
      ctx.beginPath(); ctx.moveTo(o.x-w/2,0); ctx.lineTo(o.x+w/2, o.topY + o.tilt*60); ctx.lineTo(o.x+w/2, o.topY+40+o.tilt*60); ctx.lineTo(o.x-w/2,40); ctx.closePath(); ctx.fill();
      ctx.beginPath(); ctx.moveTo(o.x-w/2,H); ctx.lineTo(o.x+w/2, H - (o.topY + o.gap/1.2) + o.tilt*30); ctx.lineTo(o.x+w/2,H - (o.topY + o.gap/1.2) - 20 + o.tilt*30); ctx.lineTo(o.x-w/2, H - 20); ctx.closePath(); ctx.fill();
    } else if(o.type==='circle'){
      ctx.fillStyle='rgba(28,46,64,0.98)';
      ctx.beginPath(); ctx.arc(o.x, o.centerY - o.r - 18, o.r+12, 0, Math.PI*2); ctx.fill();
      ctx.beginPath(); ctx.arc(o.x, o.centerY + o.r + 18, o.r+12, 0, Math.PI*2); ctx.fill();
    } else if(o.type==='triangle'){
      ctx.fillStyle='rgba(24,40,56,0.98)';
      ctx.beginPath(); ctx.moveTo(o.x,0); ctx.lineTo(o.x-90, o.mid - o.gap/2); ctx.lineTo(o.x+90, o.mid - o.gap/2); ctx.closePath(); ctx.fill();
      ctx.beginPath(); ctx.moveTo(o.x,H); ctx.lineTo(o.x-90, o.mid + o.gap/2); ctx.lineTo(o.x+90, o.mid + o.gap/2); ctx.closePath(); ctx.fill();
    } else if(o.type==='enemy'){
      ctx.save(); ctx.translate(o.x, o.y); ctx.rotate((Date.now()/250)%(Math.PI*2));
      ctx.fillStyle='rgba(255,110,110,0.95)'; ctx.beginPath(); ctx.moveTo(-o.w/2,-o.h/2); ctx.lineTo(o.w/2,0); ctx.lineTo(-o.w/2,o.h/2); ctx.closePath(); ctx.fill();
      ctx.restore();
    }
  }
}

/* ---------- Updates ---------- */
function updateObstacles(){
  obstacles.forEach(o=>{
    if(o.type==='enemy') o.x += o.vx;
    else o.x -= (baseSpeed + Math.min(4, Math.floor(tick/1200)));
  });
  obstacles = obstacles.filter(o => o.x > -260);
}

/* ---------- Collision detection ---------- */
function rectRect(ax,ay,aw,ah,bx,by,bw,bh){
  return ax < bx + bw && ax + aw > bx && ay < by + bh && ay + ah > by;
}
function checkCollision(){
  const p = player;
  if(p.y - p.h/2 < 0 || p.y + p.h/2 > H) return true;
  for(const o of obstacles){
    if(o.type==='rect' || o.type==='rectShort'){
      const rx = o.x - 48, rw=96;
      if(rectRect(p.x - p.w/2, p.y - p.h/2, p.w, p.h, rx, 0, rw, o.topH)) return true;
      if(rectRect(p.x - p.w/2, p.y - p.h/2, p.w, p.h, rx, H - o.bottomH, rw, o.bottomH)) return true;
      if(!o.passed && o.x + rw/2 < p.x - p.w/2){ o.passed=true; score++; scoreEl.textContent=score; playSFX('blip'); }
    } else if(o.type==='slanted'){
      if(p.x > o.x-80 && p.x < o.x+80){
        if(p.y < o.topY + 28 || p.y > H - (o.topY + o.gap/1.2 - 28)) return true;
      }
      if(!o.passed && o.x < p.x - p.w/2){ o.passed=true; score++; scoreEl.textContent=score; playSFX('blip'); }
    } else if(o.type==='circle'){
      const dx = Math.abs(p.x - o.x);
      const dy = Math.abs(p.y - o.centerY);
      if(dx < o.r + Math.max(p.w,p.h)/2 && dy < o.r + Math.max(p.w,p.h)/2) return true;
      if(!o.passed && o.x < p.x - p.w/2){ o.passed=true; score++; scoreEl.textContent=score; playSFX('blip'); }
    } else if(o.type==='triangle'){
      if(Math.abs(p.x - o.x) < 90 && (p.y < o.mid - o.gap/2 + 20 || p.y > o.mid + o.gap/2 - 20)) return true;
      if(!o.passed && o.x < p.x - p.w/2){ o.passed=true; score++; scoreEl.textContent=score; playSFX('blip'); }
    } else if(o.type==='enemy'){
      if(rectRect(p.x - p.w/2, p.y - p.h/2, p.w, p.h, o.x - o.w/2, o.y - o.h/2, o.w, o.h)) return true;
    }
  }
  return false;
}

/* ---------- Main loop ---------- */
let raf = null;
function loop(){
  if(!running) return;
  if(paused){ drawFrame(); raf = requestAnimationFrame(loop); return; }

  tick++;
  // physics
  player.vy += player.gravity;
  player.vy = Math.max(Math.min(player.vy, player.maxVy), -player.maxVy);
  player.y += player.vy;
  player.x += player.vx;
  player.vx *= 0.92;
  if(player.x < player.w/2) player.x = player.w/2;
  if(player.x > W - player.w/2) player.x = W - player.w/2;

  // spawn obstacles
  spawnTimer++;
  if(spawnTimer > Math.max(60, levelInfo[currentLevel].gap - Math.floor(tick/700))){
    spawnTimer = 0; spawnObstacle();
    baseSpeed = 3.0 + (currentLevel-1)*0.6 + Math.min(2, Math.floor(tick/2000));
  }

  updateObstacles();

  drawFrame();

  if(checkCollision()){
    // game over
    playSFX('boom');
    running = false;
    showGameOver();
    return;
  }

  raf = requestAnimationFrame(loop);
}

/* ---------- Rendering single frame ---------- */
function drawFrame(){
  // background
  drawStaticBG();
  // obstacles
  drawObstacles();
  // player
  drawPlayer();
  // subtle HUD drawn via DOM; no extra drawing needed
}

/* ---------- Controls: keyboard & on-screen ---------- */
const keys = {};
window.addEventListener('keydown', e=>{
  keys[e.key.toLowerCase()] = true;
  if(e.code === 'Space'){ player.vy = player.lift; playSFX('pop'); }
  // quick start when menu visible
  if(e.key==='Enter' && !running && menuOverlay.style.display!=='none') startGame();
});
window.addEventListener('keyup', e=>{ keys[e.key.toLowerCase()] = false; });

function pollInputs(){
  if(!running || paused) return;
  if(keys['arrowup'] || keys['w']){ player.y -= player.speed*3; player.vy -= 3; }
  if(keys['arrowdown'] || keys['s']){ player.y += player.speed*3; player.vy += 3; }
  if(keys['arrowleft'] || keys['a']){ player.x -= player.speed*3; player.vx = -player.speed; }
  if(keys['arrowright'] || keys['d']){ player.x += player.speed*3; player.vx = player.speed; }
}
setInterval(()=>{ if(running && !paused) pollInputs(); }, 28);

/* On-screen button binding with hold repeat */
function bindBtn(el, fn){
  let t=null;
  el.addEventListener('touchstart', (e)=>{ e.preventDefault(); fn(); t = setInterval(fn, 90); }, {passive:false});
  el.addEventListener('mousedown', ()=>{ fn(); t = setInterval(fn, 90); });
  window.addEventListener('touchend', ()=>{ if(t) clearInterval(t); });
  window.addEventListener('mouseup', ()=>{ if(t) clearInterval(t); });
}
bindBtn(leftBtn, ()=>{ player.x -= 4; player.vx = -4; });
bindBtn(rightBtn, ()=>{ player.x += 4; player.vx = 4; });
bindBtn(upBtn, ()=>{ player.y -= 4; player.vy -= 4; });
bindBtn(downBtn, ()=>{ player.y += 4; player.vy += 4; });

/* ---------- UI handlers ---------- */
playBtn.addEventListener('click', ()=>{ startGame(); });
pauseBtn.addEventListener('click', ()=>{
  paused = !paused;
  pauseBtn.textContent = paused ? 'Resume ▶' : 'Pause ⏸';
  if(!paused && running) loop();
});
toHomeBtn.addEventListener('click', ()=>{ endToHome(); });
retryBtn.addEventListener('click', ()=>{ restartGame(); });
backBtn.addEventListener('click', ()=>{ endToHome(); });

musicToggle.addEventListener('click', ()=>{
  setMusic(!musicOn);
});
resetAll.addEventListener('click', ()=>{
  // reset to defaults
  currentLevel = 1; score = 0; hiScore = 0; sessionStorage.clear(); localStorage.removeItem('gatot_hi');
  populateLevels(); levelLabel.textContent = currentLevel; scoreEl.textContent = score;
  alert('Game direset ke default (Level 1, highscore dihapus).');
});
homePlay.addEventListener('click', ()=>{ // show menu
  menuOverlay.style.display = ''; menuOverlay.style.pointerEvents='auto';
});

/* instructions */
instructionsBtn.addEventListener('click', ()=>{ instrOverlay.style.display=''; instrOverlay.style.pointerEvents='auto'; });
closeInstr.addEventListener('click', ()=>{ instrOverlay.style.display='none'; instrOverlay.style.pointerEvents='none'; });

/* ---------- Start/Stop functions ---------- */
function startGame(){
  // hide overlays
  menuOverlay.style.display='none'; menuOverlay.style.pointerEvents='none';
  gameOverOverlay.style.display='none'; instrOverlay.style.display='none';
  // reset runtime logic but preserve selected level
  score = 0; scoreEl.textContent = 0; tick=0; obstacles=[]; spawnTimer=0;
  player.x = 160; player.y = H/2; player.vy=0; player.vx=0;
  running = true; paused = false;
  levelLabel.textContent = currentLevel;
  if(!audioCtx && musicOn) initAudio();
  playSFX('pop');
  loop();
}

function restartGame(){
  gameOverOverlay.style.display='none'; gameOverOverlay.style.pointerEvents='none';
  startGame();
}

function showGameOver(){
  document.getElementById('goText').textContent = `Skor akhir: ${score}`;
  gameOverOverlay.style.display=''; gameOverOverlay.style.pointerEvents='auto';
  // save hi score
  try{
    const prev = parseInt(localStorage.getItem('gatot_hi')||'0');
    if(score > prev) localStorage.setItem('gatot_hi', String(score));
  }catch(e){}
}

/* back to home */
function endToHome(){
  running=false; paused=false;
  menuOverlay.style.display=''; menuOverlay.style.pointerEvents='auto';
  gameOverOverlay.style.display='none'; gameOverOverlay.style.pointerEvents='none';
}

/* ---------- Misc helpers ---------- */
/* draw initial frame */
drawStaticBG();
drawObstacles();
drawPlayer();

/* persist/load selected level & hi score */
try{
  const slevel = sessionStorage.getItem('gatot_level');
  if(slevel) currentLevel = parseInt(slevel);
  const hs = localStorage.getItem('gatot_hi');
  if(hs) hiScore = parseInt(hs);
} catch(e){}
populateLevels(); levelLabel.textContent = currentLevel;
scoreEl.textContent = score;

/* save level on play */
playBtn.addEventListener('click', ()=>{ try{ sessionStorage.setItem('gatot_level', String(currentLevel)); }catch(e){} });

/* simple autosave hi score periodically */
setInterval(()=>{ try{ const prev = parseInt(localStorage.getItem('gatot_hi')||'0'); if(score>prev) localStorage.setItem('gatot_hi', String(score)); }catch(e){} }, 2000);

/* touch to flap */
canvas.addEventListener('pointerdown', ()=>{ player.vy = player.lift; playSFX('pop'); });

/* music initial toggle label */
setMusic(true);

/* ensure menu visible initially */
menuOverlay.style.display = '';
menuOverlay.style.pointerEvents='auto';

</script>
</body>
</html>
